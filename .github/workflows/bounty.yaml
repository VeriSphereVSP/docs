name: VeriSphere Bounty Sync

on:
  issues:
    types: [opened, labeled, unlabeled, closed, reopened, edited]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]
  workflow_dispatch:

jobs:
  sync-bounty:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Write GCP service account key.json from secret
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          echo "$GOOGLE_CREDENTIALS_JSON" > .verisphere/scripts/key.json

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .verisphere/scripts/requirements.txt

      - name: Extract bounty metadata
        id: parse
        shell: bash
        run: |
          # Not all events have identical shapes, so guard access
          TITLE="${{ github.event.issue.title || github.event.pull_request.title || github.event.workflow_run?.display_title }}"
          URL="${{ github.event.issue.html_url || github.event.pull_request.html_url || github.event.repository.html_url }}"
          LABELS_JSON='${{ toJson(github.event.issue.labels || github.event.pull_request.labels) }}'
          ACTOR="${{ github.actor }}"
          ACTION="${{ github.event.action || 'manual' }}"
          REPO="${{ github.repository }}"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "labels=$LABELS_JSON" >> $GITHUB_OUTPUT
          echo "actor=$ACTOR" >> $GITHUB_OUTPUT
          echo "status=$ACTION" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT

      - name: Append to Google Sheet
        # Only write rows when there is at least one "bounty:" label
        if: contains(join(fromJson(steps.parse.outputs.labels).* .name, ','), 'bounty:')
        env:
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: |
          python .verisphere/scripts/update_sheet.py \
            --sheet "$SHEET_ID" \
            --title "${{ steps.parse.outputs.title }}" \
            --labels "${{ steps.parse.outputs.labels }}" \
            --actor "${{ steps.parse.outputs.actor }}" \
            --status "${{ steps.parse.outputs.status }}" \
            --repo "${{ steps.parse.outputs.repo }}" \
            --url "${{ steps.parse.outputs.url }}"

