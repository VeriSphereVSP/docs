name: Bounty Sync

on:
  issues:
    types: [opened, edited, labeled, unlabeled, closed]

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install gspread google-auth

      - name: Validate secrets
        id: secrets-check
        run: |
          echo "Checking required secrets..."
          MISSING=0
          if [ -z "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" ]; then
            echo "::error::Missing secret: GOOGLE_CREDENTIALS_JSON"
            MISSING=1
          fi
          if [ -z "${{ secrets.SHEET_ID }}" ]; then
            echo "::error::Missing secret: SHEET_ID"
            MISSING=1
          fi
          if [ "$MISSING" -eq 1 ]; then
            exit 1
          fi
          echo "All required secrets present."

      - name: Determine if bounty issue
        id: guard
        run: |
          echo "Inspecting issue labels from event file..."
          python3 << 'EOF'
          import json, os

          event_path = os.environ["GITHUB_EVENT_PATH"]
          with open(event_path) as f:
              event = json.load(f)

          issue = event.get("issue", {})
          labels = [lbl["name"] for lbl in issue.get("labels", [])]

          has_bounty = any(l == "bounty" or l.startswith("bounty:") for l in labels)

          print("Issue labels:", labels)
          print("Has bounty label:", has_bounty)

          # Write output for next step
          with open(os.environ["GITHUB_OUTPUT"], "a") as out:
              out.write(f"has_bounty={'true' if has_bounty else 'false'}\n")
          EOF

      - name: Guard â€” skip if not a bounty issue
        if: steps.guard.outputs.has_bounty == 'false'
        run: |
          echo "Skipping: Issue does not have a bounty label."
          exit 0

      - name: Run bounty sync
        if: steps.guard.outputs.has_bounty == 'true'
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          echo "Running Google Sheets sync script..."
          if [ ! -f ".verisphere/scripts/sheets_sync.py" ]; then
            echo "::error::sheets_sync.py not found at .verisphere/scripts/sheets_sync.py"
            exit 1
          fi
          python3 .verisphere/scripts/sheets_sync.py

