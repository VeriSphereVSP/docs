name: VeriSphere Bounty Sync

on:
  issues:
    types: [opened, labeled, closed, reopened, edited]
  issue_comment:
    types: [created]
  pull_request:
    types: [closed]
  workflow_dispatch:

jobs:
  sync-bounty:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Write GCP service account key.json
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          mkdir -p .verisphere/scripts
          echo "$GOOGLE_CREDENTIALS_JSON" > .verisphere/scripts/key.json

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r .verisphere/scripts/requirements.txt

      #####################################################
      # Extract metadata safely for ALL event types
      #####################################################
      - name: Extract bounty metadata
        id: parse
        shell: bash
        run: |
          # Title detection
          if [[ -n "${{ github.event.issue.title }}" ]]; then
            TITLE="${{ github.event.issue.title }}"
          elif [[ -n "${{ github.event.pull_request.title }}" ]]; then
            TITLE="${{ github.event.pull_request.title }}"
          else
            TITLE="(unknown title)"
          fi

          # URL detection
          if [[ -n "${{ github.event.issue.html_url }}" ]]; then
            URL="${{ github.event.issue.html_url }}"
          elif [[ -n "${{ github.event.pull_request.html_url }}" ]]; then
            URL="${{ github.event.pull_request.html_url }}"
          else
            URL="https://github.com/${{ github.repository }}"
          fi

          # Get labels in JSON array form (safe fallback = empty array)
          LABELS_JSON='${{ toJson(github.event.issue.labels || github.event.pull_request.labels || []) }}'

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "labels=$LABELS_JSON" >> $GITHUB_OUTPUT
          echo "actor=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "status=${{ github.event.action || 'manual' }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT

      #####################################################
      # Debug output: see exactly what we got from GitHub
      #####################################################
      - name: Debug: Show Parsed Metadata
        run: |
          echo "---- DEBUG METADATA ----"
          echo "TITLE:  ${{ steps.parse.outputs.title }}"
          echo "URL:    ${{ steps.parse.outputs.url }}"
          echo "LABELS: ${{ steps.parse.outputs.labels }}"
          echo "ACTOR:  ${{ steps.parse.outputs.actor }}"
          echo "STATUS: ${{ steps.parse.outputs.status }}"
          echo "REPO:   ${{ steps.parse.outputs.repo }}"
          echo "-------------------------"

      #####################################################
      # Debug label parsing + show condition result
      #####################################################
      - name: Debug: Evaluate bounty label condition
        id: check
        run: |
          LABELS='${{ steps.parse.outputs.labels }}'
          echo "LABELS RAW: $LABELS"
          echo "----- NAMES ----"
          echo "${LABELS}" | jq -r '.[].name'
          echo "----------------"

          BOUNTY_FOUND=$(echo "${LABELS}" | jq -r '[.[].name | select(.=="bounty")] | length')

          echo "BOUNTY_FOUND_COUNT=$BOUNTY_FOUND" >> $GITHUB_OUTPUT
          echo "Bounty label count: $BOUNTY_FOUND"

      #####################################################
      # Append to Google Sheet ONLY if bounty label exists
      #####################################################
      - name: Append to Google Sheet
        if: steps.check.outputs.BOUNTY_FOUND_COUNT != '0'
        env:
          SHEET_ID: ${{ secrets.SHEET_ID }}
        run: |
          echo "Appending bounty row to Google Sheet..."
          python .verisphere/scripts/update_sheet.py \
            --sheet "$SHEET_ID" \
            --title "${{ steps.parse.outputs.title }}" \
            --labels '${{ steps.parse.outputs.labels }}' \
            --actor "${{ steps.parse.outputs.actor }}" \
            --status "${{ steps.parse.outputs.status }}" \
            --repo "${{ steps.parse.outputs.repo }}" \
            --url "${{ steps.parse.outputs.url }}"
